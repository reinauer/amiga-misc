#!/bin/bash

# Embedded RunMe.info icon (Amiga icon file)
RUNME_INFO_HEX="e3100001000000000000000000360016000400010001070cc80000000000000000000000000000000000000000000001040007040e90000000008000000080000000000000000000000000001000000000000036001600020003642003000000000000000000000004000000000000000c000000000000000c000000000000000c000000000000000c0003f0000000000c0002083fffe0000c000207c0001c000c000200000003800c000200000000600c000200000000100c000200000000080c000207c0001fc40c000208200020320c0003f01800c00d0c000000060300030c000000020200000c000000020200000c000000020200000c00000003fe00000c000000000000000c007ffffffffffffc00fffffffffffff800d555555555555000d555555555555000d555555555555000d555555555555000d405555555555000d405400015555000d400000001555000d400000000555000d400000000155000d400000000055000d400000000055000d400000000015000d405400015415000d405400015505000d555500055545000d555540155555000d555540155555000d555540155555000d555540155555000d555555555555000800000000000000000000008433a49636f6e5800464f524d0000058449434f4e46414345000000062d2d00000041494d41470000027b001803010105022e004181049001c2218c6318b70012118c431084316f00282318862104852ef80302318862104852989c200e08c6218841214c53109c600f08c6218841214e631484e3009086218841214e63148400109e60098c431082429cc6290800214b5f383fc7fc20e214e6314840010a5a97ce01318842104a6314840010a5a12be70098c4210825314840010a5a1295f383ec41c1290800214b42529593a01fe1fd17f8430a40214b425294a57d001520422104412150a5a12962149593a402c429021104854296a4a52b5a149593a802e429481090a852c415a9295950a4ac9d4017298c52150a5886222d0c4aca852564eb00c10a63150a58862090a94312b2a149593ac03043194a58862090ab6250c4aca852564eb00c10cb5a822090ab32d894312b2a149593ac03045b169210ab314ab6250c4aca852564eb00c2d2a5a4ab314812ad894312b2a149593b0032b6250b598a4090245b128625654292b27600656c4ad26304810888b6250c4aca852564ec00cad8b494c5084411056c4a1895950a4ac9d80ff58bb16631041108615b128625654292b27603fd62e9318a4108612156c4a1895950a4ac9d201631481084853156c4a12b3150a4ac9d2016310a4214c63316c4a0a6315094949d20ff28a10a5314c562d89514865a926213a402a4318c5294ab6158952caa4a8c527383fc8225210855b16c4a94952cc527303f481c02196c2b12952cc52937c01655b0ac4acc62949bc00a32d85298c52909ba0fc37f97fc9b6006298c52909b00fd24083c0002ff00fffeb2fee7fefffe7dfe4dfe18fe0014ce6d6dae5151be5d5d8e31319e4141dfba45efe714fe8afebefed6fe55fe240ea6494986282896393965080875181800494d4147000002e500000101000502da0000810760019a0681a06ed83e1bba0ff6fcb801bbe0ff6803be4602e6f083fda18e1be118c63180dcde307fb439c37c6308c2108c06e6f283fda20e1be31846107ca731b9cde707fb449c37c6308c20f94e6718c6e6f483fda28e1be31846107ca6799c74a8dcdeb07fb459c37c6308c20f94ce73ce96bdc6e6f58061ae1c2308c20f94ce73ce96bdae3735bda0ff68b3871846107ca6739e74b5e95b8dcdeb00c35c38c61084a6739e74b5e95adc6e6b7b41fed1670e308420f99cf3a5af4ad6b71b9bd60186b871842107ccf3a5af4ad6b5adc6e6f683fda02e1fdc041f3a5af4ad714b56e3735bda01a6b86f7c21083e96bdab5adef4b56e3735bde0ff68d38727be107d2d783ef6ad6f3a5ab71b9adef00e35c394e4f7d2d784612bd315bce96adc6e6b7c41fed1c70e539ca96bc2307ca75a62b79d2d5b8dcd6f883fda38e1ccf6b5e1183e53be2b4c56f3a5ab71b9adf107fb471c39def67c1f29dcf7c5698ade74b56e3735be20ff68e3877c5eb294ee79cef8ad315bce96adc6e6b7c403cd70ef5b5eb3b9e7294ef8ad315bce96adc6e6b7cc1fed1e70ef8ad2f73ce527ca77c5698ade74b56e3735be60ff68f3877c56f539e4f93e52be2b4c56f3a5ab71b9adf307fb479c3be2f599e727bdef95f15a62b79d2d5b8dcd6f983fda3ce1def8b9ce793e0f84af8ad315bce96adc6e6b7cc1fed1e70ef7a9ce79bdf07c1f7c5698ade74b56e3735be60ff68f386318ce73ca0f8422fbe2b4adcf3a5ab71b9adf307fb7f5c34339e728422f94ef8ad2673ce95acc6e6b7cc1f8d1970cf393def94e73be2b69c8f7b54e3737c403cd0340d70cf29ca5339cf89e2b6bced5b1c6e6b7b4030d70e7394e6719e78be2b6b56d738dcdeb00c35c391ce71b867be278ad6d73cc6e6b7ac02cd70c631b9ae1cef89e2b739c6e6b7a4028d739ce6b5ae19ef89cce798dcde707e34340d6b86739ce798dcde5008340d0000d6b87339e63737741fed0670c631b9bb60ff6feb801bb20fc6eb8009a06fb8000"

# ARCHIVE=../Roadshow.lha
ARCHIVE="$1"
OK=0

if [ -r "$ARCHIVE" ];
then
  OK=1
fi

if [ $OK -ne 1 ];
then
  echo "Splitter: Split large (LHA) files and create ADF files for Gotek drives"
  echo
  echo "Usage: $0 file.lha"
  echo
  exit 1;
fi

BASE=$(basename "$ARCHIVE")
NAME=${BASE%.*}

ONEDISK=860000
FULLSIZE=$(stat -c %s "$ARCHIVE")
NUMDISKS=$(( ( $FULLSIZE + ( $ONEDISK - 1) )/ $ONEDISK ))

echo "Archive: $BASE"

if [ $NUMDISKS -eq 1 ]; then
  echo "Name:${NAME}"
  printf "Full Archive: %d fits on one disk\n" $FULLSIZE

  xdftool "$NAME.adf" create + format "$NAME" ffs
  xdftool "$NAME.adf" write "$ARCHIVE"
  xdftool "$NAME.adf" list
  echo "Success: Created $NAME.adf"
else
  echo "Name:${NAME}xx"
  printf "Full Archive: %d\nPer disk: %d\nNumber of disks: %d\n" $FULLSIZE $ONEDISK $NUMDISKS

  split --numeric-suffixes=1 -b $ONEDISK "$ARCHIVE" "$NAME."


  for i in $(seq 1 $NUMDISKS); do
    SUFFIX=$(printf "%02d" $i)
    xdftool "$NAME$i.adf" create + format "$NAME$i" ffs
    xdftool "$NAME$i.adf" write "$NAME.$SUFFIX"
  done

  (
    printf "JOIN "
    for i in $(seq 1 $NUMDISKS); do
      SUFFIX=$(printf "%02d" $i)
      printf "%s" "$NAME$i:$NAME.$SUFFIX "
    done
    printf "AS WORK:%s\n" "$BASE"
  ) > RunMe

  echo "$RUNME_INFO_HEX" | xxd -r -p > RunMe.info
  xdftool "${NAME}1.adf" write RunMe
  xdftool "${NAME}1.adf" write RunMe.info
  xdftool "${NAME}1.adf" protect RunMe SPARWED

  #for i in $(seq 1 $NUMDISKS); do
  #  xdftool "$NAME$i.adf" list
  #done

  #cat RunMe

  rm -f "$NAME".[0-9][0-9]
  rm -f RunMe RunMe.info
  echo "Success: Created $NUMDISKS ADF files (${NAME}1.adf - ${NAME}${NUMDISKS}.adf)"
fi

